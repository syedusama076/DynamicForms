@page "/form-designer"
@rendermode InteractiveServer
@using DynamicFormsBlazor.Data
@using DynamicFormsBlazor.Models
@using DynamicFormsBlazor.Components
@inject AppDbContext Db
@inject NavigationManager Navigation

<PageTitle>Form Designer</PageTitle>

<Toast @ref="ToastRef" />

<h3>Form Designer</h3>
<p>Create a dynamic form by adding fields below.</p>

<div class="card mb-3">
    <div class="card-body">
        <div class="mb-3">
            <label class="form-label">Form Name <span class="text-danger">*</span></label>
            <input class="form-control" @bind="FormName" placeholder="e.g., Contact Form" />
        </div>

        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" @bind="FormDescription" rows="2" placeholder="Optional description"></textarea>
        </div>
    </div>
</div>

<h5>Fields</h5>

@if (EditingFields.Count == 0)
{
    <div class="alert alert-info">No fields added yet. Click "Add Field" to start building your form.</div>
}

@foreach (var field in EditingFields)
{
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Key <span class="text-danger">*</span></label>
                    <input class="form-control" @bind="field.Key" placeholder="fieldKey" />
                </div>
                @if (field.Type != DynamicForm.FormFieldType.Checkbox && field.Type != DynamicForm.FormFieldType.RadioGroup)
                {
                    <div class="col-md-3">
                        <label class="form-label">@((field.Type == DynamicForm.FormFieldType.StaticText) ? "Text" : "Label") <span class="text-danger">*</span></label>
                        <input class="form-control" @bind="field.Label" placeholder="@((field.Type == DynamicForm.FormFieldType.StaticText) ? "Text to display" : "Field Label")" />
                    </div>
                }
                <div class="@(field.Type == DynamicForm.FormFieldType.Checkbox || field.Type == DynamicForm.FormFieldType.RadioGroup ? "col-md-2" : "col-md-2")">
                    <label class="form-label">Type <span class="text-danger">*</span></label>
                    <select class="form-select"
                            @bind="field.Type"
                            @bind:after="() => OnFieldTypeChanged(field)">
                        @foreach (var type in FieldTypes)
                        {
                            <option value="@type">@type</option>
                        }
                    </select>
                </div>
                <div class="@(field.Type == DynamicForm.FormFieldType.Checkbox || field.Type == DynamicForm.FormFieldType.RadioGroup ? "col-md-6" : "col-md-3")">
                    <label class="form-label">Placeholder</label>
                    <input class="form-control" @bind="field.Placeholder" placeholder="Optional" />
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-danger btn-sm w-100" @onclick="@(() => RemoveField(field))" title="Remove field">
                        <span aria-hidden="true">Ã—</span>
                    </button>
                </div>
            </div>

            @if (field.Type == DynamicForm.FormFieldType.Checkbox)
            {
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label class="form-label">Checkbox Label <span class="text-danger">*</span></label>
                        <input class="form-control" @bind="field.CheckboxLabel" placeholder="Label next to checkbox" />
                    </div>
                </div>
            }

            @* Options for Select and RadioGroup *@
            @if (field.Type == DynamicForm.FormFieldType.Select || field.Type == DynamicForm.FormFieldType.RadioGroup)
            {
                <div class="row g-3 mt-2">
                    <div class="col-12">
                        <label class="form-label">
                            Options 
                            @if (field.Type == DynamicForm.FormFieldType.RadioGroup)
                            {
                                <span class="badge bg-info ms-1">Radio buttons - only one can be selected</span>
                            }
                        </label>
                        @if (field.Options.Count == 0)
                        {
                            <div class="alert alert-warning mb-2">Add at least one option.</div>
                        }
                        @foreach (var option in field.Options)
                        {
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" @bind="option.Value" placeholder="Value" />
                                <input type="text" class="form-control" @bind="option.Text" placeholder="Display Text" />
                                <button class="btn btn-outline-danger" type="button" @onclick="@(() => RemoveOption(field, option))">Remove</button>
                            </div>
                        }
                        <button class="btn btn-sm btn-secondary" @onclick="@(() => AddOption(field))">+ Add Option</button>
                    </div>
                </div>
            }

            @if (field.Type != DynamicForm.FormFieldType.StaticText && field.Type != DynamicForm.FormFieldType.RadioGroup)
            {
                <div class="row g-3 mt-2">
                    <div class="col-12">
                        <label class="form-label">Help Text</label>
                        <input class="form-control" @bind="field.HelpText" placeholder="Optional help text shown below the field" />
                    </div>
                </div>
            }

            @* Price field for Checkbox, Number, Select, RadioGroup *@
            @if (field.Type == DynamicForm.FormFieldType.Checkbox || 
                 field.Type == DynamicForm.FormFieldType.Number || 
                 field.Type == DynamicForm.FormFieldType.Select ||
                 field.Type == DynamicForm.FormFieldType.RadioGroup)
            {
                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label class="form-label">Price ($)</label>
                        <input type="number" class="form-control" @bind="field.Price" placeholder="0.00" step="0.01" min="0" />
                    </div>
                    <div class="col-md-9 d-flex align-items-end">
                        <small class="text-muted">
                            Use <code>{price}</code> in label to show price, <code>{subtotal}</code> for calculated amount, <code>{total}</code> in StaticText for grand total.
                        </small>
                    </div>
                </div>
            }

            @* Parent field selector for nesting *@
            @{
                var potentialParents = GetPotentialParents(field);
            }
            @if (potentialParents.Any())
            {
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label class="form-label">Parent Field (for nesting)</label>
                        <select class="form-select" @bind="field.ParentFieldKey">
                            <option value="">-- No parent (root level) --</option>
                            @foreach (var parent in potentialParents)
                            {
                                <option value="@parent.Key">@parent.Key (@parent.Type)</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-8 d-flex align-items-end">
                        <small class="text-muted">
                            @if (potentialParents.Any(p => p.Type == DynamicForm.FormFieldType.StaticText))
                            {
                                <span>Checkbox parent: children show when checked. StaticText parent: children always visible (grouped).</span>
                            }
                            else
                            {
                                <span>If set, this field will only show when the parent checkbox is checked.</span>
                            }
                        </small>
                    </div>
                </div>
            }

            @* Mutually exclusive fields - only for Checkbox type *@
            @if (field.Type == DynamicForm.FormFieldType.Checkbox)
            {
                var otherCheckboxes = GetOtherCheckboxes(field);
                @if (otherCheckboxes.Any())
                {
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label class="form-label">Mutually Exclusive With</label>
                            <input type="text" class="form-control" @bind="field.MutuallyExclusiveWith" 
                                   placeholder="e.g., unableToAttend" />
                        </div>
                        <div class="col-md-8 d-flex align-items-end">
                            <small class="text-muted">
                                Comma-separated field keys. When this checkbox is checked, those fields will be unchecked.
                                <br/>Available: @string.Join(", ", otherCheckboxes.Select(c => c.Key))
                            </small>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
}

<div class="mb-3">
    <button class="btn btn-secondary me-2" @onclick="AddField">
        <span aria-hidden="true">+</span> Add Field
    </button>
    <button class="btn btn-primary" @onclick="SaveForm" >
        ðŸ’¾ Save Form
    </button>
    <button class="btn btn-outline-secondary ms-2" @onclick="Cancel">
        Cancel
    </button>
</div>

@code {
    private Toast? ToastRef;

    private string FormName { get; set; } = string.Empty;
    private string? FormDescription { get; set; }

    private List<FormFieldDefinition> EditingFields { get; set; } = new();

    private DynamicForm.FormFieldType[] FieldTypes =
        (DynamicForm.FormFieldType[])Enum.GetValues(typeof(DynamicForm.FormFieldType));

    private bool CanSave => !string.IsNullOrWhiteSpace(FormName) && 
                           EditingFields.Count > 0 && 
                           EditingFields.All(f => !string.IsNullOrWhiteSpace(f.Key) &&
                                                 // For Checkbox, require CheckboxLabel; for RadioGroup, require options; for others, require Label
                                                 (f.Type == DynamicForm.FormFieldType.Checkbox 
                                                     ? !string.IsNullOrWhiteSpace(f.CheckboxLabel) 
                                                     : f.Type == DynamicForm.FormFieldType.RadioGroup
                                                         ? f.Options.Count > 0
                                                         : !string.IsNullOrWhiteSpace(f.Label)) &&
                                                 // Select and RadioGroup need at least one option
                                                 ((f.Type != DynamicForm.FormFieldType.Select && f.Type != DynamicForm.FormFieldType.RadioGroup) || f.Options.Count > 0));

    private void AddField()
    {
        EditingFields.Add(new FormFieldDefinition
        {
            Key = $"field{EditingFields.Count + 1}",
            Label = "New Field",
            Type = DynamicForm.FormFieldType.Text
        });

        Console.WriteLine("New field count after AddField: " + EditingFields.Count);
    }

    private void RemoveField(FormFieldDefinition field)
    {
        EditingFields.Remove(field);
    }

    private void OnFieldTypeChanged(FormFieldDefinition field)
    {
        // Clear options if switching away from Select or RadioGroup
        if (field.Type != DynamicForm.FormFieldType.Select && field.Type != DynamicForm.FormFieldType.RadioGroup)
        {
            field.Options.Clear();
        }
        // Add options if switching to Select or RadioGroup and has none
        else if (field.Options.Count == 0)
        {
            AddOption(field);
            if (field.Type == DynamicForm.FormFieldType.RadioGroup)
            {
                AddOption(field); // Add second option for RadioGroup
            }
        }
    }

    private void AddOption(FormFieldDefinition field)
    {
        field.Options.Add(new FormFieldOptionDefinition
        {
            Value = $"option{field.Options.Count + 1}",
            Text = $"Option {field.Options.Count + 1}"
        });
    }

    private void RemoveOption(FormFieldDefinition field, FormFieldOptionDefinition option)
    {
        field.Options.Remove(option);
    }

    /// <summary>
    /// Get list of fields that can be parents for the given field.
    /// Checkboxes and StaticText that come BEFORE this field can be parents.
    /// </summary>
    private List<FormFieldDefinition> GetPotentialParents(FormFieldDefinition field)
    {
        var fieldIndex = EditingFields.IndexOf(field);
        if (fieldIndex <= 0) return new List<FormFieldDefinition>();

        // Get all checkbox and StaticText fields that come before this field
        return EditingFields
            .Take(fieldIndex)
            .Where(f => (f.Type == DynamicForm.FormFieldType.Checkbox || f.Type == DynamicForm.FormFieldType.StaticText) 
                        && !string.IsNullOrWhiteSpace(f.Key))
            .ToList();
    }

    /// <summary>
    /// Get list of other checkbox fields (for mutually exclusive selection).
    /// </summary>
    private List<FormFieldDefinition> GetOtherCheckboxes(FormFieldDefinition field)
    {
        return EditingFields
            .Where(f => f != field && f.Type == DynamicForm.FormFieldType.Checkbox && !string.IsNullOrWhiteSpace(f.Key))
            .ToList();
    }

    private async Task SaveForm()
    {
        if (!CanSave)
        {
            if (ToastRef is not null)
            {
                await ToastRef.ShowAsync("Please fill in all required fields (Form Name, Keys, Labels, and Checkbox Labels). Select and RadioGroup fields must have at least one option.", "danger", 4000);
            }
            return;
        }

        try
        {
            var form = new FormDefinition
            {
                Name = FormName.Trim(),
                Description = FormDescription?.Trim(),
                Fields = EditingFields.Select(f => new FormFieldDefinition
                {
                    Key = f.Key.Trim(),
                    // For Checkbox, use CheckboxLabel as Label since Label field is hidden
                    // For RadioGroup, use Key as label since it doesn't have a visible label
                    Label = f.Type == DynamicForm.FormFieldType.Checkbox 
                        ? (f.CheckboxLabel?.Trim() ?? string.Empty) 
                        : f.Type == DynamicForm.FormFieldType.RadioGroup
                            ? f.Key.Trim()
                            : f.Label.Trim(),
                    Type = f.Type,
                    Placeholder = f.Placeholder?.Trim(),
                    CheckboxLabel = f.CheckboxLabel?.Trim(),
                    HelpText = f.HelpText?.Trim(),
                    Price = f.Price,
                    ParentFieldKey = string.IsNullOrWhiteSpace(f.ParentFieldKey) ? null : f.ParentFieldKey.Trim(),
                    MutuallyExclusiveWith = string.IsNullOrWhiteSpace(f.MutuallyExclusiveWith) ? null : f.MutuallyExclusiveWith.Trim(),
                    Options = f.Options.Select(o => new FormFieldOptionDefinition
                    {
                        Value = o.Value.Trim(),
                        Text = o.Text.Trim()
                    }).ToList()
                }).ToList()
            };

            Db.FormDefinitions.Add(form);
            await Db.SaveChangesAsync();

            if (ToastRef is not null)
            {
                await ToastRef.ShowAsync($"Form saved successfully! Form ID: {form.Id}", "success");
            }
            
            // Navigate to view the form after a short delay
            await Task.Delay(1500);
            Navigation.NavigateTo($"/fill-form/{form.Id}");
        }
        catch (Exception ex)
        {
            if (ToastRef is not null)
            {
                await ToastRef.ShowAsync($"Error saving form: {ex.Message}", "danger", 4000);
            }
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }
}
