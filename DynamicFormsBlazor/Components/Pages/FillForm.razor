@page "/fill-form"
@page "/fill-form/{FormName?}"
@rendermode InteractiveServer
@using DynamicFormsBlazor.Data
@using DynamicFormsBlazor.Models
@using DynamicFormsBlazor.Components
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@inject NavigationManager Navigation
@inject IConfiguration Configuration
@inject IHttpClientFactory HttpClientFactory

<PageTitle>Fill Form</PageTitle>

<Toast @ref="ToastRef" />

@if (IsLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading...</p>
    </div>
}
else if (FormName is null)
{
    <h3>Forms</h3>

    @if (AllForms.Count == 0)
    {
        <div class="alert alert-info">
            No forms found. Go to the <a href="/form-designer">Form Designer</a> to create one.
        </div>
    }
    else
    {
        <div class="list-group">
            @foreach (var form in AllForms)
            {
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <a class="text-decoration-none" href="@($"/fill-form/{form.Name.Replace(" ", "")}")">
                                <h5 class="mb-1">@form.Name</h5>
                            </a>
                            @if (!string.IsNullOrWhiteSpace(form.Description))
                            {
                                <p class="mb-1 text-muted">@form.Description</p>
                            }
                            <small class="text-muted">ID: @form.Id</small>
                        </div>
                        <div class="ms-3">
                            <a class="btn btn-sm btn-outline-primary" href="@($"/form-designer/{form.Name.Replace(" ", "")}")" title="Edit Form">
                                ✏️ Edit
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
}
else if (FormDefinition is null)
{
    <div class="alert alert-warning">
        <h4>Form Not Found</h4>
        <p>The form "@FormName" could not be found.</p>
        <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/fill-form"))">Back to Forms</button>
    </div>
}
else
{
    <div class="aoa-form-header mb-2">
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1 text-center pe-3">
                <h2 class="mb-2">@FormDefinition.Name</h2>
                @if (!string.IsNullOrWhiteSpace(FormDefinition.Description))
                {
                    <p class="mb-0">@FormDefinition.Description</p>
                }
            </div>
            <div class="ms-2">
                <a class="aoa-edit-btn" href="@($"/form-designer/{FormDefinition.Name.Replace(" ", "")}")" title="Edit form layout">
                    <span class="aoa-edit-icon">✏️</span>
                    <span>Edit</span>
                </a>
            </div>
        </div>
    </div>

    <hr class="aoa-form-divider" />

    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            @* Match original AOA form's "* Required" row (aligned with field labels) *@
            <div class="aoa-required-note text-danger mb-2">
                <span>* Required</span>
            </div>

            <DynamicForm @ref="DynamicFormRef"
                         Fields="Fields"
                         Values="Values"
                         SubmitText="Submit/Pay Now"
                         ShowCaptcha="@IsCaptchaEnabled"
                         CaptchaSiteKey="@CaptchaSiteKey"
                         OnSubmit="HandleSubmit" />
        </div>
    </div>

}

@code {
    [Parameter] public string? FormName { get; set; }

    private Toast? ToastRef;
    private DynamicForm? DynamicFormRef;

    private List<FormDefinition> AllForms { get; set; } = new();
    private FormDefinition? FormDefinition { get; set; }
    private List<DynamicForm.FormField>? Fields;
    private Dictionary<string, object?> Values = new();
    private string? LastSubmittedJson;

    private bool IsLoading = true;
    private bool IsCaptchaEnabled = false;
    private string? CaptchaSiteKey;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check CAPTCHA configuration
            IsCaptchaEnabled = Configuration.GetValue<bool>("ReCaptcha:Enabled", false);
            CaptchaSiteKey = Configuration["ReCaptcha:SiteKey"];
            
            // Only enable CAPTCHA if both enabled flag is true AND site key is provided
            if (IsCaptchaEnabled && string.IsNullOrWhiteSpace(CaptchaSiteKey))
            {
                IsCaptchaEnabled = false;
            }
            
            // Always load form list
            AllForms = await Db.FormDefinitions
                .OrderBy(f => f.Name)
                .ToListAsync();

            // If a specific form name is requested, load that form
            if (FormName is not null)
            {
                // FormName in URL has spaces removed, so we need to compare with normalized names
                FormDefinition = await Db.FormDefinitions
                    .Include(f => f.Fields)
                    .ThenInclude(f => f.Options)
                    .FirstOrDefaultAsync(f => f.Name.Replace(" ", "") == FormName);

                if (FormDefinition is not null)
                {
                    Fields = FormDefinition.Fields.Select(f => 
                    {
                        // Load option prices from DefaultValueJson (stored as JSON dictionary)
                        var optionPrices = ParseOptionPrices(f.DefaultValueJson);
                        
                        return new DynamicForm.FormField
                        {
                            Key = f.Key,
                            Label = f.Label,
                            Type = f.Type,
                            IsRequired = f.IsRequired,
                            Placeholder = f.Placeholder,
                            CheckboxLabel = f.CheckboxLabel,
                            HelpText = f.HelpText,
                            DefaultValue = ParseDefaultValue(f.DefaultValueJson),
                            Price = f.Price,
                            ParentFieldKey = f.ParentFieldKey,
                            MutuallyExclusiveWith = ParseMutuallyExclusiveWith(f.MutuallyExclusiveWith),
                            Options = f.Options.Select(o => new DynamicForm.FormFieldOption
                            {
                                Value = o.Value,
                                Text = o.Text,
                                Price = optionPrices.TryGetValue(o.Value, out var price) ? price : (decimal?)null
                            }).ToList()
                        };
                    }).ToList();
                }
            }
        }
        catch (Exception ex)
        {
            // Log error in production
            Console.WriteLine($"Error loading forms: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private object? ParseDefaultValue(string? defaultValueJson)
    {
        if (string.IsNullOrWhiteSpace(defaultValueJson))
            return null;

        try
        {
            // Try to parse as OptionPricingConfig first (new format)
            var config = System.Text.Json.JsonSerializer.Deserialize<OptionPricingConfig>(defaultValueJson);
            if (config != null)
            {
                // This is option pricing config, not a default value
                return null;
            }
        }
        catch
        {
            // If that fails, try old format (just dictionary of prices)
            try
            {
                var dict = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, decimal>>(defaultValueJson);
                if (dict != null && dict.Count > 0)
                {
                    // This is option prices, not a default value
                    return null;
                }
            }
            catch
            {
                // Ignore
            }
        }

        try
        {
            return System.Text.Json.JsonSerializer.Deserialize<object>(defaultValueJson);
        }
        catch
        {
            return defaultValueJson;
        }
    }

    private Dictionary<string, decimal> ParseOptionPrices(string? defaultValueJson)
    {
        if (string.IsNullOrWhiteSpace(defaultValueJson))
            return new Dictionary<string, decimal>();

        try
        {
            // Try new format first (OptionPricingConfig)
            var config = System.Text.Json.JsonSerializer.Deserialize<OptionPricingConfig>(defaultValueJson);
            if (config != null)
            {
                // Only return prices if per-option pricing is enabled
                if (config.UsePerOptionPricing && config.OptionPrices != null)
                {
                    return config.OptionPrices;
                }
                // If UsePerOptionPricing is false, return empty (don't use option prices)
                return new Dictionary<string, decimal>();
            }
        }
        catch
        {
            // If deserialization as OptionPricingConfig fails, try old format (just dictionary)
            try
            {
                var prices = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, decimal>>(defaultValueJson);
                return prices ?? new Dictionary<string, decimal>();
            }
            catch
            {
                return new Dictionary<string, decimal>();
            }
        }

        return new Dictionary<string, decimal>();
    }

    // Helper class for option pricing configuration
    private class OptionPricingConfig
    {
        public bool UsePerOptionPricing { get; set; }
        public Dictionary<string, decimal> OptionPrices { get; set; } = new();
    }

    private List<string>? ParseMutuallyExclusiveWith(string? mutuallyExclusiveWith)
    {
        if (string.IsNullOrWhiteSpace(mutuallyExclusiveWith))
            return null;

        // Parse comma-separated list of field keys
        return mutuallyExclusiveWith
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(s => s.Trim())
            .Where(s => !string.IsNullOrEmpty(s))
            .ToList();
    }

    private async Task HandleSubmit(Dictionary<string, object?> values)
    {
        LastSubmittedJson = System.Text.Json.JsonSerializer.Serialize(
            values,
            new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        if (FormName is null || FormDefinition is null)
        {
            return;
        }

        try
        {
            // Validate CAPTCHA if enabled
            var captchaEnabled = Configuration.GetValue<bool>("ReCaptcha:Enabled", true);
            if (captchaEnabled)
            {
                if (!values.TryGetValue("_captchaResponse", out var captchaResponseObj) || 
                    string.IsNullOrWhiteSpace(captchaResponseObj?.ToString()))
                {
                    if (ToastRef is not null)
                    {
                        await ToastRef.ShowAsync("Please complete the CAPTCHA verification.", "danger");
                    }
                    return;
                }

                var captchaResponse = captchaResponseObj.ToString();
                var secretKey = Configuration["ReCaptcha:SecretKey"];
                
                if (!string.IsNullOrWhiteSpace(secretKey) && !await ValidateCaptchaAsync(captchaResponse!, secretKey))
                {
                    if (ToastRef is not null)
                    {
                        await ToastRef.ShowAsync("CAPTCHA verification failed. Please try again.", "danger");
                    }
                    return;
                }
            }

            var rawJson = System.Text.Json.JsonSerializer.Serialize(values);
            
            // Get the calculated total from the DynamicForm component
            var totalAmount = DynamicFormRef?.GetTotal() ?? 0;

            var submission = new FormSubmission
            {
                FormDefinitionId = FormDefinition.Id,
                DataJson = rawJson,
                TotalAmount = totalAmount
            };

            Db.FormSubmissions.Add(submission);
            await Db.SaveChangesAsync();

            if (ToastRef is not null)
            {
                var message = totalAmount > 0 
                    ? $"Form submitted successfully! Total: {totalAmount:C}" 
                    : "Form submitted successfully!";
                await ToastRef.ShowAsync(message, "success");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving form submission: {ex.Message}");
            if (ToastRef is not null)
            {
                await ToastRef.ShowAsync("Error saving form submission. Please try again.", "danger");
            }
        }
    }

    private void ResetForm()
    {
        LastSubmittedJson = null;
        Values = new Dictionary<string, object?>();
    }

    private async Task<bool> ValidateCaptchaAsync(string captchaResponse, string secretKey)
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient();
            var requestUri = $"https://www.google.com/recaptcha/api/siteverify?secret={secretKey}&response={captchaResponse}";
            
            var response = await httpClient.PostAsync(requestUri, null);
            if (response.IsSuccessStatusCode)
            {
                var jsonResponse = await response.Content.ReadAsStringAsync();
                var result = System.Text.Json.JsonSerializer.Deserialize<CaptchaVerificationResponse>(jsonResponse);
                return result?.Success == true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error validating CAPTCHA: {ex.Message}");
        }
        return false;
    }

    private class CaptchaVerificationResponse
    {
        public bool Success { get; set; }
    }
}
