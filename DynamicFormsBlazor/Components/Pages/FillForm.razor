@page "/fill-form"
@page "/fill-form/{FormName?}"
@rendermode InteractiveServer
@using DynamicFormsBlazor.Data
@using DynamicFormsBlazor.Models
@using DynamicFormsBlazor.Components
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@inject NavigationManager Navigation

<PageTitle>Fill Form</PageTitle>

<Toast @ref="ToastRef" />

@if (IsLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading...</p>
    </div>
}
else if (FormName is null)
{
    <h3>Forms</h3>

    @if (AllForms.Count == 0)
    {
        <div class="alert alert-info">
            No forms found. Go to the <a href="/form-designer">Form Designer</a> to create one.
        </div>
    }
    else
    {
        <div class="list-group">
            @foreach (var form in AllForms)
            {
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <a class="text-decoration-none" href="@($"/fill-form/{Uri.EscapeDataString(form.Name.Replace(" ", ""))}")">
                                <h5 class="mb-1">@form.Name</h5>
                            </a>
                            @if (!string.IsNullOrWhiteSpace(form.Description))
                            {
                                <p class="mb-1 text-muted">@form.Description</p>
                            }
                            <small class="text-muted">ID: @form.Id</small>
                        </div>
                        <div class="ms-3">
                            <a class="btn btn-sm btn-outline-primary" href="@($"/form-designer/{Uri.EscapeDataString(form.Name.Replace(" ", ""))}")" title="Edit Form">
                                ✏️ Edit
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
}
else if (FormDefinition is null)
{
    <div class="alert alert-warning">
        <h4>Form Not Found</h4>
        <p>The form "@FormName" could not be found.</p>
        <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/fill-form"))">Back to Forms</button>
    </div>
}
else
{
    <div class="aoa-form-header mb-2">
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1 pe-3">
                <h2 class="mb-2 text-center">@FormDefinition.Name</h2>
                @if (!string.IsNullOrWhiteSpace(FormDefinition.Description))
                {
                    <p class="mb-0 text-left">@FormDefinition.Description</p>
                }
            </div>
            <!-- <div class="ms-2">
                <a class="aoa-edit-btn" href="@($"/form-designer/{FormDefinition.Name.Replace(" ", "")}")" title="Edit form layout">
                    <span class="aoa-edit-icon">✏️</span>
                    <span>Edit</span>
                </a>
            </div> -->
        </div>
    </div>

    <hr class="aoa-form-divider" />

    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <DynamicForm @ref="DynamicFormRef"
                         Fields="Fields"
                         Values="Values"
                         SubmitText="Submit/Pay Now"
                         OnSubmit="HandleSubmit" />
        </div>
    </div>

}

@code {
    [Parameter] public string? FormName { get; set; }

    private Toast? ToastRef;
    private DynamicForm? DynamicFormRef;

    private List<FormDefinition> AllForms { get; set; } = new();
    private FormDefinition? FormDefinition { get; set; }
    private List<DynamicForm.FormField>? Fields;
    private Dictionary<string, object?> Values = new();
    private string? LastSubmittedJson;

    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Always load form list
            AllForms = await Db.FormDefinitions
                .OrderBy(f => f.Name)
                .ToListAsync();

            // If a specific form name is requested, load that form
            if (FormName is not null)
            {
                // Decode URL-encoded form name and normalize (remove spaces)
                var decodedFormName = Uri.UnescapeDataString(FormName);
                var normalizedFormName = decodedFormName.Replace(" ", "");
                
                // Try to parse as ID first, then fall back to name lookup
                if (int.TryParse(normalizedFormName, out var formId))
                {
                    // Look up by ID - use AsSplitQuery to avoid potential issues with multiple collections
                    FormDefinition = await Db.FormDefinitions
                        .Include(f => f.Fields)
                            .ThenInclude(f => f.Options)
                        .AsSplitQuery()
                        .FirstOrDefaultAsync(f => f.Id == formId);
                }
                else
                {
                    // FormName in URL has spaces removed, so we need to compare with normalized names
                    FormDefinition = await Db.FormDefinitions
                        .Include(f => f.Fields)
                        .ThenInclude(f => f.Options)
                        .AsSplitQuery()
                        .FirstOrDefaultAsync(f => f.Name.Replace(" ", "") == normalizedFormName);
                }

                if (FormDefinition is not null)
                {
                    if (FormDefinition.Fields == null)
                    {
                        Fields = new List<DynamicForm.FormField>();
                    }
                    else
                    {
                        Fields = FormDefinition.Fields.Select(f => 
                        {
                            // Load option prices from DefaultValueJson (stored as JSON dictionary)
                            var optionPrices = ParseOptionPrices(f.DefaultValueJson);
                            
                            return new DynamicForm.FormField
                            {
                                Key = f.Key ?? string.Empty,
                                Label = f.Label ?? string.Empty,
                                Type = f.Type,
                                IsRequired = f.IsRequired,
                                Placeholder = f.Placeholder,
                                CheckboxLabel = f.CheckboxLabel,
                                HelpText = f.HelpText,
                                DefaultValue = ParseDefaultValue(f.DefaultValueJson),
                                Price = f.Price,
                                ParentFieldKey = f.ParentFieldKey,
                                MutuallyExclusiveWith = ParseMutuallyExclusiveWith(f.MutuallyExclusiveWith),
                                Options = f.Options?.Select(o => new DynamicForm.FormFieldOption
                                {
                                    Value = o.Value ?? string.Empty,
                                    Text = o.Text ?? string.Empty,
                                    Price = optionPrices.TryGetValue(o.Value ?? string.Empty, out var price) ? price : (decimal?)null
                                }).ToList() ?? new List<DynamicForm.FormFieldOption>()
                            };
                        }).ToList();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // Error loading forms - silently continue
        }
        finally
        {
            IsLoading = false;
        }
    }

    private object? ParseDefaultValue(string? defaultValueJson)
    {
        if (string.IsNullOrWhiteSpace(defaultValueJson))
            return null;

        try
        {
            // Try to parse as OptionPricingConfig first (new format)
            var config = System.Text.Json.JsonSerializer.Deserialize<OptionPricingConfig>(defaultValueJson);
            if (config != null)
            {
                // This is option pricing config, not a default value
                return null;
            }
        }
        catch
        {
            // If that fails, try old format (just dictionary of prices)
            try
            {
                var dict = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, decimal>>(defaultValueJson);
                if (dict != null && dict.Count > 0)
                {
                    // This is option prices, not a default value
                    return null;
                }
            }
            catch
            {
                // Ignore
            }
        }

        try
        {
            return System.Text.Json.JsonSerializer.Deserialize<object>(defaultValueJson);
        }
        catch
        {
            return defaultValueJson;
        }
    }

    private Dictionary<string, decimal> ParseOptionPrices(string? defaultValueJson)
    {
        if (string.IsNullOrWhiteSpace(defaultValueJson))
            return new Dictionary<string, decimal>();

        try
        {
            // Try new format first (OptionPricingConfig)
            var config = System.Text.Json.JsonSerializer.Deserialize<OptionPricingConfig>(defaultValueJson);
            if (config != null)
            {
                // Only return prices if per-option pricing is enabled
                if (config.UsePerOptionPricing && config.OptionPrices != null)
                {
                    return config.OptionPrices;
                }
                // If UsePerOptionPricing is false, return empty (don't use option prices)
                return new Dictionary<string, decimal>();
            }
        }
        catch
        {
            // If deserialization as OptionPricingConfig fails, try old format (just dictionary)
            try
            {
                var prices = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, decimal>>(defaultValueJson);
                return prices ?? new Dictionary<string, decimal>();
            }
            catch
            {
                return new Dictionary<string, decimal>();
            }
        }

        return new Dictionary<string, decimal>();
    }

    // Helper class for option pricing configuration
    private class OptionPricingConfig
    {
        public bool UsePerOptionPricing { get; set; }
        public Dictionary<string, decimal> OptionPrices { get; set; } = new();
    }

    private List<string>? ParseMutuallyExclusiveWith(string? mutuallyExclusiveWith)
    {
        if (string.IsNullOrWhiteSpace(mutuallyExclusiveWith))
            return null;

        // Parse comma-separated list of field keys
        return mutuallyExclusiveWith
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(s => s.Trim())
            .Where(s => !string.IsNullOrEmpty(s))
            .ToList();
    }

    private async Task HandleSubmit(Dictionary<string, object?> values)
    {
        if (FormName is null || FormDefinition is null)
        {
            return;
        }

        try
        {
            // Validate required fields
            var missingRequiredFields = new List<string>();
            foreach (var field in Fields!)
            {
                if (field.IsRequired && IsFieldValueEmpty(field, values))
                {
                    missingRequiredFields.Add(field.Label ?? field.Key);
                }
            }

            if (missingRequiredFields.Count > 0)
            {
                if (ToastRef is not null)
                {
                    var fieldsList = string.Join(", ", missingRequiredFields);
                    await ToastRef.ShowAsync($"Please fill in all required fields: {fieldsList}", "danger");
                }
                return;
            }

            var rawJson = System.Text.Json.JsonSerializer.Serialize(values);
            
            // Get the calculated total from the DynamicForm component
            var totalAmount = DynamicFormRef?.GetTotal() ?? 0;

            var submission = new FormSubmission
            {
                FormDefinitionId = FormDefinition.Id,
                DataJson = rawJson,
                TotalAmount = totalAmount,
                SubmittedAt = DateTime.UtcNow
            };

            Db.FormSubmissions.Add(submission);
            await Db.SaveChangesAsync();

            // Store for debugging (optional)
            LastSubmittedJson = System.Text.Json.JsonSerializer.Serialize(
                values,
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true });

            // Reset form after successful submission
            ResetForm();

            if (ToastRef is not null)
            {
                var message = totalAmount > 0 
                    ? $"Form submitted successfully! Total: {totalAmount:C}" 
                    : "Form submitted successfully!";
                await ToastRef.ShowAsync(message, "success");
            }
        }
        catch (Exception ex)
        {
            if (ToastRef is not null)
            {
                await ToastRef.ShowAsync($"Error saving form submission: {ex.Message}", "danger");
            }
        }
    }

    private bool IsFieldValueEmpty(DynamicForm.FormField field, Dictionary<string, object?> values)
    {
        if (!values.TryGetValue(field.Key, out var value) || value == null)
        {
            return true;
        }

        // Check different field types
        switch (field.Type)
        {
            case DynamicForm.FormFieldType.Checkbox:
                // For checkboxes, empty means unchecked (false)
                return !(value is bool boolValue && boolValue);
            
            case DynamicForm.FormFieldType.Table:
                // For tables, empty means no rows
                if (value is List<Dictionary<string, object?>> tableData)
                {
                    return tableData.Count == 0;
                }
                return true;
            
            case DynamicForm.FormFieldType.Number:
                // For numbers, empty means null or empty string (zero is a valid value)
                if (value is string strValue)
                {
                    return string.IsNullOrWhiteSpace(strValue);
                }
                // If it's already a number type, it's not empty
                return false;
            
            case DynamicForm.FormFieldType.Select:
            case DynamicForm.FormFieldType.RadioGroup:
                // For selects/radios, empty means no selection
                return string.IsNullOrWhiteSpace(value?.ToString());
            
            default:
                // For text/date fields, empty means null or whitespace
                return string.IsNullOrWhiteSpace(value?.ToString());
        }
    }

    private void ResetForm()
    {
        LastSubmittedJson = null;
        Values = new Dictionary<string, object?>();
    }

}
