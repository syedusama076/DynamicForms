@page "/fill-form"
@page "/fill-form/{FormId:int?}"
@rendermode InteractiveServer
@using DynamicFormsBlazor.Data
@using DynamicFormsBlazor.Models
@using DynamicFormsBlazor.Components
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@inject NavigationManager Navigation

<PageTitle>Fill Form</PageTitle>

@if (ShowToast && ToastMessage is not null)
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
        <div class="@($"toast show text-bg-{ToastCssClass} border-0 shadow")" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    @ToastMessage
                </div>
                <button type="button"
                        class="btn-close btn-close-white me-2 m-auto"
                        aria-label="Close"
                        @onclick="HideToast">
                </button>
            </div>
        </div>
    </div>
}

@if (IsLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading...</p>
    </div>
}
else if (FormId is null)
{
    <h3>Forms</h3>

    @if (AllForms.Count == 0)
    {
        <div class="alert alert-info">
            No forms found. Go to the <a href="/form-designer">Form Designer</a> to create one.
        </div>
    }
    else
    {
        <div class="list-group">
            @foreach (var form in AllForms)
            {
                <a class="list-group-item list-group-item-action"
                   href="@($"/fill-form/{form.Id}")">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">@form.Name</h5>
                        <small class="text-muted">ID: @form.Id</small>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(form.Description))
                    {
                        <p class="mb-1 text-muted">@form.Description</p>
                    }
                </a>
            }
        </div>
    }
}
else if (FormDefinition is null)
{
    <div class="alert alert-warning">
        <h4>Form Not Found</h4>
        <p>The form with ID @FormId could not be found.</p>
        <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/fill-form"))">Back to Forms</button>
    </div>
}
else
{
    <div class="mb-4 text-center">
        <h2 class="mb-2">@FormDefinition.Name</h2>
        @if (!string.IsNullOrWhiteSpace(FormDefinition.Description))
        {
            <p class="text-muted mb-1">@FormDefinition.Description</p>
        }
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <DynamicForm Fields="Fields"
                         Values="Values"
                         SubmitText="Submit"
                         OnSubmit="HandleSubmit" />
        </div>
    </div>

    @if (LastSubmittedJson is not null)
    {
        <div class="card mt-4">
            <div class="card-header">
                <h5>âœ… Form Submitted Successfully</h5>
            </div>
            <div class="card-body">
                <p>Submitted values:</p>
                <pre class="bg-light p-3 rounded">@LastSubmittedJson</pre>
                <button class="btn btn-primary" @onclick="ResetForm">Fill Again</button>
                <button class="btn btn-outline-secondary ms-2" @onclick="@(() => Navigation.NavigateTo("/form-designer"))">Create New Form</button>
            </div>
        </div>
    }
}

@code {
    [Parameter] public int? FormId { get; set; }

    private List<FormDefinition> AllForms { get; set; } = new();
    private FormDefinition? FormDefinition { get; set; }
    private List<DynamicForm.FormField>? Fields;
    private Dictionary<string, object?> Values = new();
    private string? LastSubmittedJson;

    private bool ShowToast;
    private string? ToastMessage;
    private string ToastCssClass = "success";

    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Always load form list
            AllForms = await Db.FormDefinitions
                .OrderBy(f => f.Name)
                .ToListAsync();

            // If a specific form ID is requested, load that form
            if (FormId is not null)
            {
                FormDefinition = await Db.FormDefinitions
                    .Include(f => f.Fields)
                    .ThenInclude(f => f.Options)
                    .FirstOrDefaultAsync(f => f.Id == FormId.Value);

                if (FormDefinition is not null)
                {
                    Fields = FormDefinition.Fields.Select(f => new DynamicForm.FormField
                    {
                        Key = f.Key,
                        Label = f.Label,
                        Type = f.Type,
                        Placeholder = f.Placeholder,
                        CheckboxLabel = f.CheckboxLabel,
                        HelpText = f.HelpText,
                        DefaultValue = ParseDefaultValue(f.DefaultValueJson),
                        Options = f.Options.Select(o => new DynamicForm.FormFieldOption
                        {
                            Value = o.Value,
                            Text = o.Text
                        }).ToList()
                    }).ToList();
                }
            }
        }
        catch (Exception ex)
        {
            // Log error in production
            Console.WriteLine($"Error loading forms: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private object? ParseDefaultValue(string? defaultValueJson)
    {
        if (string.IsNullOrWhiteSpace(defaultValueJson))
            return null;

        try
        {
            // Try to parse as JSON, fallback to string
            return System.Text.Json.JsonSerializer.Deserialize<object>(defaultValueJson);
        }
        catch
        {
            return defaultValueJson;
        }
    }

    private async Task HandleSubmit(Dictionary<string, object?> values)
    {
        LastSubmittedJson = System.Text.Json.JsonSerializer.Serialize(
            values,
            new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        if (FormId is null)
        {
            return;
        }

        try
        {
            var rawJson = System.Text.Json.JsonSerializer.Serialize(values);

            var submission = new FormSubmission
            {
                FormDefinitionId = FormId.Value,
                DataJson = rawJson
            };

            Db.FormSubmissions.Add(submission);
            await Db.SaveChangesAsync();

            await ShowToastMessage("Form submitted successfully.", "success");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving form submission: {ex.Message}");
            await ShowToastMessage("Error saving form submission. Please try again.", "danger");
        }
    }

    private void ResetForm()
    {
        LastSubmittedJson = null;
        Values = new Dictionary<string, object?>();
    }

    private async Task ShowToastMessage(string message, string type)
    {
        ToastMessage = message;
        ToastCssClass = type;
        ShowToast = true;
        await InvokeAsync(StateHasChanged);

        // Auto-hide after a short delay
        await Task.Delay(3000);
        ShowToast = false;
        await InvokeAsync(StateHasChanged);
    }

    private void HideToast()
    {
        ShowToast = false;
    }
}

