@page "/fill-form"
@page "/fill-form/{FormId:int?}"
@rendermode InteractiveServer
@using DynamicFormsBlazor.Data
@using DynamicFormsBlazor.Models
@using DynamicFormsBlazor.Components
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@inject NavigationManager Navigation

<PageTitle>Fill Form</PageTitle>

<Toast @ref="ToastRef" />

@if (IsLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading...</p>
    </div>
}
else if (FormId is null)
{
    <h3>Forms</h3>

    @if (AllForms.Count == 0)
    {
        <div class="alert alert-info">
            No forms found. Go to the <a href="/form-designer">Form Designer</a> to create one.
        </div>
    }
    else
    {
        <div class="list-group">
            @foreach (var form in AllForms)
            {
                <a class="list-group-item list-group-item-action"
                   href="@($"/fill-form/{form.Id}")">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">@form.Name</h5>
                        <small class="text-muted">ID: @form.Id</small>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(form.Description))
                    {
                        <p class="mb-1 text-muted">@form.Description</p>
                    }
                </a>
            }
        </div>
    }
}
else if (FormDefinition is null)
{
    <div class="alert alert-warning">
        <h4>Form Not Found</h4>
        <p>The form with ID @FormId could not be found.</p>
        <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/fill-form"))">Back to Forms</button>
    </div>
}
else
{
    <div class="mb-4 text-center">
        <h2 class="mb-2">@FormDefinition.Name</h2>
        @if (!string.IsNullOrWhiteSpace(FormDefinition.Description))
        {
            <p class="text-muted mb-1">@FormDefinition.Description</p>
        }
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <DynamicForm @ref="DynamicFormRef"
                         Fields="Fields"
                         Values="Values"
                         SubmitText="Submit"
                         OnSubmit="HandleSubmit" />
        </div>
    </div>

}

@code {
    [Parameter] public int? FormId { get; set; }

    private Toast? ToastRef;
    private DynamicForm? DynamicFormRef;

    private List<FormDefinition> AllForms { get; set; } = new();
    private FormDefinition? FormDefinition { get; set; }
    private List<DynamicForm.FormField>? Fields;
    private Dictionary<string, object?> Values = new();
    private string? LastSubmittedJson;

    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Always load form list
            AllForms = await Db.FormDefinitions
                .OrderBy(f => f.Name)
                .ToListAsync();

            // If a specific form ID is requested, load that form
            if (FormId is not null)
            {
                FormDefinition = await Db.FormDefinitions
                    .Include(f => f.Fields)
                    .ThenInclude(f => f.Options)
                    .FirstOrDefaultAsync(f => f.Id == FormId.Value);

                if (FormDefinition is not null)
                {
                    Fields = FormDefinition.Fields.Select(f => new DynamicForm.FormField
                    {
                        Key = f.Key,
                        Label = f.Label,
                        Type = f.Type,
                        Placeholder = f.Placeholder,
                        CheckboxLabel = f.CheckboxLabel,
                        HelpText = f.HelpText,
                        DefaultValue = ParseDefaultValue(f.DefaultValueJson),
                        Price = f.Price,
                        ParentFieldKey = f.ParentFieldKey,
                        MutuallyExclusiveWith = ParseMutuallyExclusiveWith(f.MutuallyExclusiveWith),
                        Options = f.Options.Select(o => new DynamicForm.FormFieldOption
                        {
                            Value = o.Value,
                            Text = o.Text
                        }).ToList()
                    }).ToList();
                }
            }
        }
        catch (Exception ex)
        {
            // Log error in production
            Console.WriteLine($"Error loading forms: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private object? ParseDefaultValue(string? defaultValueJson)
    {
        if (string.IsNullOrWhiteSpace(defaultValueJson))
            return null;

        try
        {
            // Try to parse as JSON, fallback to string
            return System.Text.Json.JsonSerializer.Deserialize<object>(defaultValueJson);
        }
        catch
        {
            return defaultValueJson;
        }
    }

    private List<string>? ParseMutuallyExclusiveWith(string? mutuallyExclusiveWith)
    {
        if (string.IsNullOrWhiteSpace(mutuallyExclusiveWith))
            return null;

        // Parse comma-separated list of field keys
        return mutuallyExclusiveWith
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(s => s.Trim())
            .Where(s => !string.IsNullOrEmpty(s))
            .ToList();
    }

    private async Task HandleSubmit(Dictionary<string, object?> values)
    {
        LastSubmittedJson = System.Text.Json.JsonSerializer.Serialize(
            values,
            new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        if (FormId is null)
        {
            return;
        }

        try
        {
            var rawJson = System.Text.Json.JsonSerializer.Serialize(values);
            
            // Get the calculated total from the DynamicForm component
            var totalAmount = DynamicFormRef?.GetTotal() ?? 0;

            var submission = new FormSubmission
            {
                FormDefinitionId = FormId.Value,
                DataJson = rawJson,
                TotalAmount = totalAmount
            };

            Db.FormSubmissions.Add(submission);
            await Db.SaveChangesAsync();

            if (ToastRef is not null)
            {
                var message = totalAmount > 0 
                    ? $"Form submitted successfully! Total: {totalAmount:C}" 
                    : "Form submitted successfully!";
                await ToastRef.ShowAsync(message, "success");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving form submission: {ex.Message}");
            if (ToastRef is not null)
            {
                await ToastRef.ShowAsync("Error saving form submission. Please try again.", "danger");
            }
        }
    }

    private void ResetForm()
    {
        LastSubmittedJson = null;
        Values = new Dictionary<string, object?>();
    }
}
